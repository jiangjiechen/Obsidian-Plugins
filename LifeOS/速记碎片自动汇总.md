
```dataviewjs
// 汇总全库中包含二级标题“速记 / 碎片”的文档内容。
// 为避免自引用，跳过当前文件。

const { DateTime } = dv.luxon;

async function extractFragment(path) {
  const raw = await dv.io.load(path);
  if (!raw) return null;
  const text = raw.replace(/\r\n/g, "\n");
  // 匹配以“## 速记 / 碎片”为起点，到下一个一级/二级标题或文末
  const re = /(^|\n)##\s*速记\s*\/\s*碎片\s*\n([\s\S]*?)(?=\n#{1,2}\s|$)/i;
  const m = text.match(re);
  if (!m) return null;
  const body = (m[2] || "").trim();
  if (!body || body.replace(/\s/g, "").length === 0) return null;
  return body;
}

function parseTitleDate(name) {
  if (!name) return null;

  const full = name.match(/(\d{4})-(\d{2})-(\d{2})/);
  if (full) {
    const dt = DateTime.fromObject({
      year: Number(full[1]),
      month: Number(full[2]),
      day: Number(full[3])
    });
    if (dt.isValid) return dt;
  }

  const compact = name.match(/(\d{4})(\d{2})(\d{2})/);
  if (compact) {
    const dt = DateTime.fromObject({
      year: Number(compact[1]),
      month: Number(compact[2]),
      day: Number(compact[3])
    });
    if (dt.isValid) return dt;
  }

  const week = name.match(/(\d{4})-W(\d{2})/i);
  if (week) {
    const dt = DateTime.fromObject({
      weekYear: Number(week[1]),
      weekNumber: Number(week[2]),
      weekday: 1
    });
    if (dt.isValid) return dt;
  }

  const month = name.match(/(\d{4})-(\d{2})(?!-\d)/);
  if (month) {
    const dt = DateTime.fromObject({
      year: Number(month[1]),
      month: Number(month[2]),
      day: 1
    });
    if (dt.isValid) return dt;
  }

  const zhFull = name.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);
  if (zhFull) {
    const dt = DateTime.fromObject({
      year: Number(zhFull[1]),
      month: Number(zhFull[2]),
      day: Number(zhFull[3])
    });
    if (dt.isValid) return dt;
  }

  const zhMonth = name.match(/(\d{4})年(\d{1,2})月/);
  if (zhMonth) {
    const dt = DateTime.fromObject({
      year: Number(zhMonth[1]),
      month: Number(zhMonth[2]),
      day: 1
    });
    if (dt.isValid) return dt;
  }

  return null;
}

// 收集所有 markdown 页面（排除当前页）
const pages = dv.pages()
  .where(p => p.file && p.file.path && p.file.path.endsWith('.md'))
  .where(p => p.file.path !== dv.current().file.path);

let items = [];
for (let p of pages) {
  const frag = await extractFragment(p.file.path);
  if (frag) {
    const titleDate = parseTitleDate(p.file.name);
    items.push({
      path: p.file.path,
      name: p.file.name,
      mtime: p.file.mtime,
      ctime: p.file.ctime,
      frag,
      titleDate
    });
  }
}

// 优先按标题中的日期倒序排列，如无日期则按修改时间倒序
items.sort((a, b) => {
  if (a.titleDate && b.titleDate) {
    return b.titleDate.toMillis() - a.titleDate.toMillis();
  }
  if (a.titleDate) return -1;
  if (b.titleDate) return 1;
  return b.mtime.toMillis() - a.mtime.toMillis();
});

// 渲染
dv.header(3, `共收集到 ${items.length} 篇文档的“速记 / 碎片”`);
for (const it of items) {
  // 容器
  const box = dv.el('div', '', { cls: 'fragments-merged' });

  // 标题（用 Markdown 渲染，保持链接效果）
  const headMd = `#### [[${it.path}|${it.name}]] · 速记 / 碎片`;
  await obsidian.MarkdownRenderer.renderMarkdown(headMd, box, it.path, dv.component);

  // 片段内容（Markdown 渲染，保持相对资源/链接可用）
  await obsidian.MarkdownRenderer.renderMarkdown(it.frag, box, it.path, dv.component);
}
```

